#!/usr/bin/env php
<?php

// Detecting composer
if (file_exists(__DIR__ . '/../autoload.php')) {
    // Inside composer's bin
    $composer = __DIR__ . '/../';
} elseif (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    // Standalone
    $composer = __DIR__ . '/../vendor/';
} else {
    echo "Cant find Composer autoloader.", PHP_EOL, PHP_EOL;
    exit(127);
}

// Autoloader
require $composer . 'autoload.php';

$targets = [$argv[1]];

// Instantiating PHP code sniffer
$phpcs = new \Gotterdemarung\Hammer\PhpCodeSniffer($composer . 'bin/phpcs', 'PSR2');

// Instantiating PHP mess detector
$phpmd = new \Gotterdemarung\Hammer\PhpMessDetector($composer . 'bin/phpmd');

// Instantiating PHP copy paste detector
$phpcp = new \Gotterdemarung\Hammer\PhpCopyPasteDetector($composer . 'bin/phpcpd');

// Instantiating PHP code lines analyzer
$phpcl = new \Gotterdemarung\Hammer\PhpLocAnalyzer($composer . 'bin/phploc');

// Calculating score
foreach ($targets as $target) {
    if (!file_exists($target) || !is_dir($target)) {
        echo PHP_EOL, 'Wrong target ', $target, PHP_EOL;
        continue;
    }

    echo PHP_EOL;
    echo 'Score for ', $target, ' (lower is better)', PHP_EOL;
    $phpCsScore = $phpcs->getScore($target);
    echo ' * PHP Code Sniffer score: ', $phpCsScore, PHP_EOL;
    $phpMdScore = $phpmd->getScore($target);
    echo ' * PHP Mess Detector score: ', $phpMdScore, PHP_EOL;
    $phpCpScore = $phpcp->getScore($target);
    echo ' * PHP Copy-Paste score: ', $phpCpScore, PHP_EOL;
    $phpLcScore = $phpcl->getScore($target);
    echo ' * PHP LLOC/CLOC score: ', $phpLcScore, PHP_EOL;
    echo PHP_EOL;
    $totalScore = $phpCsScore * 3 + $phpMdScore * 17 + $phpCpScore * 2;
    $totalScore = intval($totalScore / -$phpLcScore * 1000);
    echo ' * Hammerscore: ', $totalScore, PHP_EOL;
    echo PHP_EOL;
}

echo PHP_EOL;